name: Build and deploy

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

concurrency:
  group: ${{ github.workflow }}

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3

    - name: Set up flyctl
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Install Nix
      uses: cachix/install-nix-action@4b933aa7ebcc94a6174cf1364864e957b4910265 # v21
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config:
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          substituters = https://cache.garnix.io
          trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=

    - name: Build and load container image
      shell: bash
      run: |
        nix build .#container
        docker load < result

    - name: Publish image and deploy
      shell: bash
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      run: |
        flyctl auth docker
        flyctl deploy
