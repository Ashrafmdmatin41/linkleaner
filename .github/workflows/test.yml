name: Check Rust code

on:
  push:
    branches:
      - main
      - renovate/**
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}

jobs:
  check:
    uses: msfjarvis/shared-workflows/.github/workflows/test-flakes-project.yml@main
    with:
      extra-targets: '.#container'
    secrets:
      github-token: ${{ secrets.GITHUB_TOKEN }}
      cachix-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

  deploy:
    needs: [ "check" ]
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    name: Deploy app
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b # v3

    - name: Set up flyctl
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Install Nix
      uses: cachix/install-nix-action@daddc62a2e67d1decb56e028c9fa68344b9b7c2a # tag=v18
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config:
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    - name: Set up Cachix (msfjarvis)
      uses: cachix/cachix-action@6a9a34cdd93d0ae4b4b59fd678660efb08109f2f # tag=v12
      with:
        name: msfjarvis

    - name: Build and load container image
      shell: bash
      run: |
        nix build .#container
        docker load < result

    - name: Publish image and deploy
      shell: bash
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      run: |
        flyctl auth docker
        docker push registry.fly.io/linkleaner:latest-x86_64-linux
        flyctl deploy
